<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מצגת בית כנסת חכמה</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --accent-color: #fbbf24;
            --card-bg: #1e293b;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        .frame {
            border: 8px solid var(--accent-color);
            height: 96vh;
            margin: 1vh;
            box-sizing: border-box;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            background-image: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .slide {
            display: none;
            text-align: center;
            width: 90%; /* Wider width */
            height: 92%; /* Maximum height utilization within the frame */
            
            /* Flexbox settings to stretch the content */
            flex-direction: column;
            justify-content: flex-start; /* Starts from the top */
            align-items: center;
            animation: fadeIn 0.8s ease-in-out;
        }

        .slide.active {
            display: flex;
        }

        /* 1. Title settings change */
        h1 {
            font-size: 2.5em; /* Reduced from 4.5em to 2.5em */
            color: var(--accent-color);
            margin: 0 0 10px 0; /* Reduced bottom margin from 30px to 10px */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            line-height: 1.2; /* Reduced line height */
            flex-shrink: 0; /* Prevents the title from shrinking */
        }

        h2 {
            font-size: 1.8em; /* Reduced from 3em */
            margin-bottom: 10px;
            color: #e2e8f0;
            flex-shrink: 0;
        }

        h3 {
            font-size: 1.8em;
            color: #cbd5e1; /* Light gray */
            font-weight: normal;
            margin-top: -15px; /* Brings it closer to the weekly portion */
            margin-bottom: 25px;
        }

        .content-box {
            background-color: rgba(30, 41, 59, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            
            /* --- Here is the change --- */
            font-size: 2.6em; /* Increased from 2.2em. Can change to 3.0em if needed more */
            /* ------------------ */
            
            width: 100%;
            flex-grow: 1; 
            overflow-y: auto; 
            min-height: 0; 
        }

        /* Time styling */
        .time-row {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            border-bottom: 1px dashed #475569;
            padding-bottom: 10px;
        }

        /* List styling */
        ul { list-style: none; padding: 0; margin: 0; }
        li {
            padding: 15px 0;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
        }
        li:last-child { border-bottom: none; }
        
        .role { font-weight: bold; color: var(--accent-color); }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 8px;
            background-color: var(--accent-color);
            width: 0%;
        }
        
        /* Loading message */
        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: var(--accent-color);
        }

        /* Hide scrollbar in Chrome/Android browsers */
        .content-box::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar in new standard */
        .content-box {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Cancel regular bullets */
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%; /* Ensures the list takes full width */
        }

        /* Row styling - The big fix */
        /* Row styling */
        li {
            padding: 10px 0; /* A bit less vertical space to look tighter */
            border-bottom: 1px solid #334155;
            
            /* Flexbox Settings */
            display: flex;
            flex-direction: row;
            justify-content: flex-start; /* Starts from the right */
            align-items: center; /* Fix: Aligns the star and text to the middle of the row vertically */
            
            direction: rtl;
            text-align: right;
            width: 100%;
        }

        /* The Star of David */
        li::before {
            content: "✡"; 
            color: var(--accent-color); 
            font-size: 1.4em; /* Kept large, but now centered */
            
            margin-left: 20px; /* Generous space between star and text */
            line-height: 1; /* Prevents extra spaces in height */
            
            flex-shrink: 0; 
        }

        /* Styling for the role column (first, second...) - The second fix */
        .role {
            font-weight: bold;
            color: var(--accent-color);
            
            /* Create a fixed column */
            min-width: 150px; /* Fixed width for role */
            display: inline-block;
            
            margin-left: 10px; /* Small margin for extra safety */
            flex-shrink: 0; /* Won't shrink if name is too long */
        }

        /* Styling for images (will add this in JS code soon) */
        .slide-image {
            max-width: 100%;
            max-height: 50vh; /* Won't take the whole screen */
            border-radius: 10px;
            margin: 10px auto;
            display: block;
            border: 3px solid var(--accent-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .logo {
            position: absolute; /* Allows precise placement within the frame */
            top: 40px;          /* Distance from top */
            right: 20px;         /* Distance from left side */
            width:100px;       /* Logo width - play with this number as needed */
            height: auto;       /* Keeps proportions */
            z-index: 100;       /* Ensures it's always above slides */
            
            /* Subtle shadow effect to stand out on dark background */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));

            /*mix-blend-mode: multiply; /* Makes white transparent (only works if logo is black-white) */
            
            /* If your logo is a white square, add the next line to round corners: */
            border-radius: 50%; 
            transform: translate(-50%, -50%);
        }

        #digital-clock {
            position: absolute;
            top: 15px; /* A bit above the progress bar */
            left: 60px;
            
            font-size: 2.2em; /* Large and clear */
            font-weight: bold;
            color: var(--text-color); /* White */
            background-color: rgba(15, 23, 42, 0.8); /* Semi-transparent background to stand out if text passes behind */
            padding: 3px 10px;
            border-radius: 10px;
            
            /* Optional golden border styling */
            border: 1px solid var(--accent-color);
            
            z-index: 100;
            
            /* Prevents the clock from "jumping" when digits change */
            font-variant-numeric: tabular-nums; 
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        #special-day-text {
            font-size: 1.6em;
            color: var(--accent-color); /* Golden */
            margin-top: -15px;
            margin-bottom: 20px;
            font-weight: bold;
            min-height: 1.6em; /* Reserves space even if no text, so design doesn't jump */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<div id="loader">טוען נתונים...</div>

<div class="frame" id="main-frame">
    <img src="Yachad-Logo.png" class="logo" alt="לוגו">
    <div id="digital-clock">--:--:--</div>
    <div class="slide" id="slide-shabbat">
        <h1 id="parasha-name">...</h1>
        <h3 id="hebrew-date-display" style="color: #94a3b8; margin-top: -10px; margin-bottom: 20px;">...</h3>
        <h4 id="special-day-text"></h4>
        <div class="content-box">
            <div class="time-row">
    <span id="label-candles">כניסת שבת:</span> <span id="candles-time" style="color: var(--accent-color)">--:--</span>
</div>
<div class="time-row">
    <span id="label-havdalah">יציאת שבת:</span> <span id="havdalah-time" style="color: var(--accent-color)">--:--</span>
</div>
        </div>
    </div>

    <div class="progress-bar" id="progress"></div>
</div>

<script>
    // ==========================================
    // הגדרות
    // ==========================================
    const READERS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpQmb6-3vOGGYVVkQWQpHbGr5hp7NwRmDgwAw7b8zwoB5Tk3MJrVZReEet5CfcNSTTUBlIUq2ASOUd/pub?gid=0&single=true&output=csv';
    const NEWS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpQmb6-3vOGGYVVkQWQpHbGr5hp7NwRmDgwAw7b8zwoB5Tk3MJrVZReEet5CfcNSTTUBlIUq2ASOUd/pub?gid=1737085330&single=true&output=csv';
    const SLIDE_DURATION = 10000; 
    const REFRESH_INTERVAL = 5 * 60 * 1000; // בדיקת עדכונים כל 5 דקות
    // ==========================================

    let slides = []; 
    let currentSlideIndex = 0;
    let scrollInterval = null;
    let lastFetchTime = 0; // מתי בדקנו פעם אחרונה

    // פונקציית עזר לקריאת CSV (גרסה מתוקנת לתמיכה בגרשיים ופסיקים בתוך טקסט)
    async function fetchCSV(url) {
        const cacheBuster = "&t=" + new Date().getTime(); 
        const res = await fetch(url + cacheBuster);
        const text = await res.text();
        
        // פירוק לשורות
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

        // פירוק לעמודות עם טיפול חכם בגרשיים
        const data = lines.map(row => {
            // הביטוי הרגולרי הזה מפרק לפי פסיקים, אלא אם כן הם בתוך גרשיים
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            
            return cols.map(col => {
                let c = col.trim();
                // אם הטקסט עטוף בגרשיים - נסיר אותם
                if (c.startsWith('"') && c.endsWith('"')) {
                    c = c.slice(1, -1);
                    // נהפוך גרשיים כפולים ("") לגרשיים רגילים (")
                    c = c.replace(/""/g, '"');
                }
                return c;
            });
        });

        return data.slice(1); // החזרת המידע ללא שורת הכותרת
    }

    async function buildDynamicSlides() {
        const frame = document.getElementById('main-frame');
        
        // 1. מחיקת שקופיות דינמיות ישנות
        const existingDynamic = document.querySelectorAll('.dynamic-slide');
        existingDynamic.forEach(el => el.remove());

        // ============================================================
        // חלק א': רשימות מובנות (קוראים, בעלי תפקידים, תורמים)
        // ============================================================
        try {
            const listData = await fetchCSV(READERS_CSV_URL);
            
            if (listData.length > 0) {
                let slidesContent = [];
                // ברירת מחדל: אם אין כותרת בהתחלה, נקרא לזה "רשימה"
                let currentSlide = { title: "קוראים בתורה", items: [] }; 
                let isNextLineTitle = false;

                listData.forEach(row => {
                    const col1 = row[0] ? row[0].trim() : '';
                    const col2 = row[1] ? row[1].trim() : '';
                    
                    // דילוג על שורות ריקות לגמרי
                    if (!col1 && !col2) return;

                    // זיהוי דף חדש
                    if (col1.includes('*****')) {
                        if (currentSlide.items.length > 0) {
                            slidesContent.push(currentSlide);
                        }
                        currentSlide = { title: "", items: [] };
                        isNextLineTitle = true;
                    } 
                    else if (isNextLineTitle) {
                        // השורה שאחרי הכוכביות היא הכותרת
                        currentSlide.title = col1; // הכותרת נמצאת בעמודה הראשונה
                        isNextLineTitle = false;
                    } 
                    else {
                        // שורה רגילה של מידע (תפקיד + שם)
                        currentSlide.items.push({ role: col1, name: col2 });
                    }
                });

                // הוספת השקופית האחרונה
                if (currentSlide.items.length > 0) {
                    slidesContent.push(currentSlide);
                }

                // יצירת ה-HTML
                slidesContent.forEach(slide => {
                    const div = document.createElement('div');
                    div.className = 'slide dynamic-slide';
                    
                    // בניית הרשימה עם ה-CSS של role שכבר בנינו
                    let html = `<h1>${slide.title}</h1><div class="content-box"><ul>`;
                    slide.items.forEach(item => {
                        html += `<li>
                                    <span class="role">${item.role}</span>
                                    <span>${item.name}</span>
                                 </li>`;
                    });
                    html += `</ul></div>`;
                    
                    div.innerHTML = html;
                    frame.insertBefore(div, document.getElementById('progress'));
                });
            }
        } catch (e) { console.error("Error fetching Lists:", e); }

        // ============================================================
        // חלק ב': הודעות וחדשות (טקסט חופשי ותמונות)
        // ============================================================
        try {
            const newsData = await fetchCSV(NEWS_CSV_URL);
            
            if (newsData.length > 0) {
                let slidesContent = [];
                let currentSlide = { title: "הודעות הקהילה", items: [] };
                let isNextLineTitle = false;

                newsData.forEach(row => {
                    const text = row[0] ? row[0].trim() : '';
                    if (!text) return;

                    if (text.includes('*****')) {
                        if (currentSlide.items.length > 0 || currentSlide.title !== "הודעות הקהילה") {
                            slidesContent.push(currentSlide);
                        }
                        currentSlide = { title: "", items: [] };
                        isNextLineTitle = true;
                    } 
                    else if (isNextLineTitle) {
                        currentSlide.title = text;
                        isNextLineTitle = false;
                    } 
                    else {
                        if (text.startsWith('IMG:')) {
                            const imgUrl = text.replace('IMG:', '').trim();
                            currentSlide.items.push({ type: 'image', value: imgUrl });
                        } else {
                            currentSlide.items.push({ type: 'text', value: text });
                        }
                    }
                });

                if (currentSlide.items.length > 0) {
                    slidesContent.push(currentSlide);
                }

                slidesContent.forEach(slide => {
                    const div = document.createElement('div');
                    div.className = 'slide dynamic-slide';
                    let html = `<h1>${slide.title}</h1><div class="content-box"><ul>`;
                    slide.items.forEach(item => {
                        if (item.type === 'image') {
                            html += `<img src="${item.value}" class="slide-image" alt="תמונה">`;
                        } else {
                            html += `<li>${item.value}</li>`;
                        }
                    });
                    html += `</ul></div>`;
                    div.innerHTML = html;
                    frame.insertBefore(div, document.getElementById('progress'));
                });
            }
        } catch (e) { console.error("Error fetching News:", e); }
        
        slides = document.querySelectorAll('.slide');
    }

    async function loadShabbatTimes() {
        try {
            // הוספנו פרמטר &o=on כדי לוודא שנקבל את ספירת העומר
            const response = await fetch('https://www.hebcal.com/shabbat?cfg=json&geonameid=294071&M=on&lg=he&o=on&t=' + new Date().getTime()); 
            const data = await response.json();
            
            // --- שלב 1: כותרת ראשית (חג או פרשה) ---
            let titleText = "";
            const holidayItem = data.items.find(i => i.category === "holiday" && !i.title.includes("ערב") && !i.title.includes("נר")); // מתעלמים מנרות חנוכה בכותרת הראשית
            const parashaItem = data.items.find(i => i.category === "parashat");

            // שמירת הפריטים לשימוש מאוחר יותר
            const mainItems = [holidayItem, parashaItem];

            if (holidayItem) {
                titleText = holidayItem.hebrew;
                // עדכון כיתובים לחג
                const lc = document.getElementById('label-candles');
                const lh = document.getElementById('label-havdalah');
                if(lc) lc.innerText = "כניסת החג:";
                if(lh) lh.innerText = "יציאת החג:";
            } else if (parashaItem) {
                titleText = parashaItem.hebrew;
                 // עדכון כיתובים לשבת
                const lc = document.getElementById('label-candles');
                const lh = document.getElementById('label-havdalah');
                if(lc) lc.innerText = "כניסת שבת:";
                if(lh) lh.innerText = "יציאת שבת:";
            } else {
                titleText = "ברוכים הבאים";
            }
            
            document.getElementById('parasha-name').innerText = titleText;

            // --- שלב 2: אירועים מיוחדים (התוספת החדשה) ---
            let specialEvents = [];

            // בדיקת ספירת העומר
            const omerItem = data.items.find(i => i.category === "omer");
            if (omerItem) {
                // Hebcal מחזיר "Sefirat HaOmer: 25". אנחנו רוצים רק את העברית.
                specialEvents.push(omerItem.hebrew); 
            }

            // בדיקת ראש חודש
            const roshChodesh = data.items.find(i => i.category === "roshchodesh");
            if (roshChodesh) {
                specialEvents.push(roshChodesh.hebrew);
            }

            // בדיקת דברים נוספים (נר חנוכה, חול המועד) שלא הופיעו בכותרת
            data.items.forEach(item => {
                if (item.category === "holiday" && item !== holidayItem) {
                    // אם זה חנוכה (שיש לו נרות) או חול המועד
                    if (item.hebrew.includes("נר") || item.hebrew.includes("חול המועד")) {
                        specialEvents.push(item.hebrew);
                    }
                }
            });

            // הצגה במסך: מחברים את הכל עם מקף מפריד
            const specialText = specialEvents.join(" | ");
            document.getElementById('special-day-text').innerText = specialText;


            // --- שלב 3: תאריך עברי וזמנים (ללא שינוי) ---
            let dateISO = parashaItem ? parashaItem.date : (holidayItem ? holidayItem.date : null);
            if (dateISO) {
                 dateISO = dateISO.substring(0, 10);
                 try {
                    const dateRes = await fetch(`https://www.hebcal.com/converter?cfg=json&date=${dateISO}&g2h=1&strict=1`);
                    const dateData = await dateRes.json();
                    const cleanDate = dateData.hebrew.replace(/[\u0591-\u05C7]/g, ''); 
                    document.getElementById('hebrew-date-display').innerText = cleanDate;
                } catch (err) { console.log("Date error"); }
            }

            const candles = data.items.find(i => i.category === "candles");
            const havdalah = data.items.find(i => i.category === "havdalah");

            if(candles) {
                const d = new Date(candles.date);
                document.getElementById('candles-time').innerText = d.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
            }

            if(havdalah) {
                const d = new Date(havdalah.date);
                document.getElementById('havdalah-time').innerText = d.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
            }

        } catch(e) { console.log("Hebcal error", e); }
    }


    // --- לוגיקת גלילה (מהקוד הקודם) ---
    function startAutoScroll(slideElement) {
        const box = slideElement.querySelector('.content-box');
        if (box) box.scrollTop = 0;
        
        if (box && box.scrollHeight > box.clientHeight) {
            setTimeout(() => {
                const distance = box.scrollHeight - box.clientHeight;
                const timeAvailable = SLIDE_DURATION - 3000; 
                const speed = distance / (timeAvailable / 20); 
                
                scrollInterval = setInterval(() => {
                    box.scrollTop += 1; 
                    if (box.scrollTop + box.clientHeight >= box.scrollHeight) {
                        clearInterval(scrollInterval);
                    }
                }, 30); 
            }, 2000);
        }
    }

    // --- ניהול המצגת ---
    async function showSlide(index) {
        // בדיקה: אם חזרנו להתחלה, האם הגיע הזמן לרענן נתונים?
        const now = new Date().getTime();
        if (index === 0 && (now - lastFetchTime > REFRESH_INTERVAL)) {
            console.log("Refreshing data...");
            await buildDynamicSlides(); // בנייה מחדש של ה-DOM
            await loadShabbatTimes();
            lastFetchTime = now;
        }

        if (scrollInterval) clearInterval(scrollInterval);
        
        // עדכון NodeList למקרה שהשתנה
        slides = document.querySelectorAll('.slide');
        
        // הגנה מפני אינדקס חורג (אם מחקנו שקופיות)
        if (index >= slides.length) index = 0;
        currentSlideIndex = index;

        slides.forEach(s => s.classList.remove('active'));
        slides[currentSlideIndex].classList.add('active');
        
        startAutoScroll(slides[currentSlideIndex]);
        
        const bar = document.getElementById('progress');
        bar.style.transition = 'none';
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = `width ${SLIDE_DURATION}ms linear`;
            bar.style.width = '100%';
        }, 50);
    }

    function nextSlide() {
        // קידום האינדקס
        let nextIndex = (currentSlideIndex + 1) % slides.length;
        showSlide(nextIndex);
    }

    // --- אתחול ראשוני ---
    async function init() {
        await loadShabbatTimes();
        await buildDynamicSlides();
        document.getElementById('loader').style.display = 'none';
        lastFetchTime = new Date().getTime();
        
        slides = document.querySelectorAll('.slide');
        showSlide(0);
        setInterval(nextSlide, SLIDE_DURATION);
    }

    function updateClock() {
        const now = new Date();
        // עיצוב הזמן בפורמט HH:MM
        const timeString = now.toLocaleTimeString('he-IL', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const clockEl = document.getElementById('digital-clock');
        if (clockEl) clockEl.innerText = timeString;
    }

    // הפעלה ראשונית
    updateClock();
    
    // עדכון כל שנייה
    setInterval(updateClock, 1000);

    init();
    
    // ריענון דף מלא פעם ב-4 שעות ליתר ביטחון (ניקוי זיכרון)
    setTimeout(() => location.reload(), 14400000); 

</script>    
</body>
</html>
