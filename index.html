<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מצגת בית כנסת חכמה</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --accent-color: #fbbf24;
            --card-bg: #1e293b;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        .frame {
            border: 8px solid var(--accent-color);
            height: 96vh;
            margin: 1vh;
            box-sizing: border-box;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 20px;
            background-image: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .slide {
            display: none;
            text-align: center;
            width: 90%; /* רחב יותר */
            height: 92%; /* ניצול מקסימלי של הגובה בתוך המסגרת */
            
            /* הגדרות Flexbox כדי למתוח את התוכן */
            flex-direction: column;
            justify-content: flex-start; /* מתחיל מלמעלה */
            align-items: center;
            animation: fadeIn 0.8s ease-in-out;
        }

        .slide.active {
            display: flex;
        }

        /* 1. שינוי הגדרות הכותרת */
        h1 {
            font-size: 2.5em; /* הקטנו מ-4.5em ל-2.5em */
            color: var(--accent-color);
            margin: 0 0 10px 0; /* צמצמנו את הרווח התחתון מ-30px ל-10px */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            line-height: 1.2; /* צמצום גובה השורה */
            flex-shrink: 0; /* מונע מהכותרת להתכווץ */
        }

        h2 {
            font-size: 1.8em; /* הקטנו מ-3em */
            margin-bottom: 10px;
            color: #e2e8f0;
            flex-shrink: 0;
        }

        h3 {
            font-size: 1.8em;
            color: #cbd5e1; /* אפור בהיר */
            font-weight: normal;
            margin-top: -15px; /* מקרב אותו לפרשת השבוע */
            margin-bottom: 25px;
        }

        .content-box {
            background-color: rgba(30, 41, 59, 0.9);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            
            /* --- כאן השינוי --- */
            font-size: 2.6em; /* הגדלנו מ-2.2em. אפשר לשנות ל-3.0em אם צריך עוד */
            /* ------------------ */
            
            width: 100%;
            flex-grow: 1; 
            overflow-y: auto; 
            min-height: 0; 
        }

        /* עיצוב זמנים */
        .time-row {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            border-bottom: 1px dashed #475569;
            padding-bottom: 10px;
        }

        /* עיצוב רשימות */
        ul { list-style: none; padding: 0; margin: 0; }
        li {
            padding: 15px 0;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
        }
        li:last-child { border-bottom: none; }
        
        .role { font-weight: bold; color: var(--accent-color); }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 8px;
            background-color: var(--accent-color);
            width: 0%;
        }
        
        /* הודעת טעינה */
        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: var(--accent-color);
        }

        /* הסתרת פס הגלילה בדפדפני כרום/אנדרואיד */
        .content-box::-webkit-scrollbar {
            display: none;
        }
        /* הסתרת פס הגלילה בסטנדרט החדש */
        .content-box {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* ביטול הנקודות הרגילות */
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%; /* מוודא שהרשימה תופסת את כל הרוחב */
        }

        /* עיצוב השורה - התיקון הגדול */
        /* עיצוב השורה */
        li {
            padding: 10px 0; /* קצת פחות רווח אנכי כדי שיראה מהודק */
            border-bottom: 1px solid #334155;
            
            /* Flexbox Settings */
            display: flex;
            flex-direction: row;
            justify-content: flex-start; /* מתחיל מימין */
            align-items: center; /* התיקון: מיישר את הכוכב והטקסט לאמצע השורה אנכית */
            
            direction: rtl;
            text-align: right;
            width: 100%;
        }

        /* המגן דוד */
        li::before {
            content: "✡"; 
            color: var(--accent-color); 
            font-size: 1.4em; /* השארתי גדול, אבל עכשיו זה ימורכז */
            
            margin-left: 20px; /* רווח נדיב בין הכוכב לטקסט */
            line-height: 1; /* מונע רווחים מיותרים בגובה */
            
            flex-shrink: 0; 
        }

        /* עיצוב העמודה של התפקיד (ראשון, שני...) - התיקון השני */
        .role {
            font-weight: bold;
            color: var(--accent-color);
            
            /* יצירת עמודה קבועה */
            min-width: 150px; /* רוחב קבוע לתפקיד */
            display: inline-block;
            
            margin-left: 10px; /* מרווח קטן ליתר ביטחון */
            flex-shrink: 0; /* שלא יתכווץ אם השם ארוך מדי */
        }

        /* עיצוב לתמונות (נוסיף את זה בקוד JS תכף) */
        .slide-image {
            max-width: 100%;
            max-height: 50vh; /* שלא יתפוס את כל המסך */
            border-radius: 10px;
            margin: 10px auto;
            display: block;
            border: 3px solid var(--accent-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .logo {
            position: absolute; /* מאפשר למקם אותו במדויק בתוך המסגרת */
            top: 30px;          /* מרחק מלמעלה */
            left: 30px;         /* מרחק מצד שמאל */
            width: 150px;       /* רוחב הלוגו - תשחק עם המספר הזה לפי הצורך */
            height: auto;       /* שומר על פרופורציות */
            z-index: 100;       /* מוודא שהוא תמיד מעל השקופיות */
            
            /* אפקט הצללה עדין כדי שיבלוט על הרקע הכהה */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));

           /* mix-blend-mode: multiply; /* גורם ללבן להפוך לשקוף (עובד רק אם הלוגו שחור-לבן) */
            
            /* אם הלוגו שלך הוא ריבוע לבן, תוסיף את השורה הבאה כדי לעגל פינות: */
             border-radius: 50%; 
        }

        #digital-clock {
            position: absolute;
            bottom: 25px; /* קצת מעל פס ההתקדמות */
            left: 30px;
            
            font-size: 2.5em; /* גדול וברור */
            font-weight: bold;
            color: var(--text-color); /* לבן */
            background-color: rgba(15, 23, 42, 0.8); /* רקע חצי שקוף כדי שיבלוט אם טקסט עובר מאחוריו */
            padding: 5px 15px;
            border-radius: 10px;
            
            /* עיצוב גבול זהוב עדין - אופציונלי */
            border: 1px solid var(--accent-color);
            
            z-index: 100;
            
            /* מונע מהשעון "לקפוץ" כשהספרות מתחלפות */
            font-variant-numeric: tabular-nums; 
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

<div id="loader">טוען נתונים...</div>

<div class="frame" id="main-frame">
    <img src="Yachad-Logo.png" class="logo" alt="לוגו">
    <div id="digital-clock">--:--:--</div>
    <div class="slide" id="slide-shabbat">
        <h1 id="parasha-name">...</h1>
        <h3 id="hebrew-date-display" style="color: #94a3b8; margin-top: -10px; margin-bottom: 20px;">...</h3>
        <div class="content-box">
            <div class="time-row">
                <span>כניסת שבת:</span>
                <span id="candles-time" style="color: var(--accent-color)">--:--</span>
            </div>
            <div class="time-row">
                <span>יציאת שבת:</span>
                <span id="havdalah-time" style="color: var(--accent-color)">--:--</span>
            </div>
        </div>
    </div>

    <div class="progress-bar" id="progress"></div>
</div>

<script>
    // ==========================================
    // הגדרות
    // ==========================================
    const READERS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpQmb6-3vOGGYVVkQWQpHbGr5hp7NwRmDgwAw7b8zwoB5Tk3MJrVZReEet5CfcNSTTUBlIUq2ASOUd/pub?gid=0&single=true&output=csv';
    const NEWS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpQmb6-3vOGGYVVkQWQpHbGr5hp7NwRmDgwAw7b8zwoB5Tk3MJrVZReEet5CfcNSTTUBlIUq2ASOUd/pub?gid=1737085330&single=true&output=csv';
    const SLIDE_DURATION = 10000; 
    const REFRESH_INTERVAL = 5 * 60 * 1000; // בדיקת עדכונים כל 5 דקות
    // ==========================================

    let slides = []; 
    let currentSlideIndex = 0;
    let scrollInterval = null;
    let lastFetchTime = 0; // מתי בדקנו פעם אחרונה

    // פונקציית עזר לקריאת CSV (גרסה מתוקנת לתמיכה בגרשיים ופסיקים בתוך טקסט)
    async function fetchCSV(url) {
        const cacheBuster = "&t=" + new Date().getTime(); 
        const res = await fetch(url + cacheBuster);
        const text = await res.text();
        
        // פירוק לשורות
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

        // פירוק לעמודות עם טיפול חכם בגרשיים
        const data = lines.map(row => {
            // הביטוי הרגולרי הזה מפרק לפי פסיקים, אלא אם כן הם בתוך גרשיים
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            
            return cols.map(col => {
                let c = col.trim();
                // אם הטקסט עטוף בגרשיים - נסיר אותם
                if (c.startsWith('"') && c.endsWith('"')) {
                    c = c.slice(1, -1);
                    // נהפוך גרשיים כפולים ("") לגרשיים רגילים (")
                    c = c.replace(/""/g, '"');
                }
                return c;
            });
        });

        return data.slice(1); // החזרת המידע ללא שורת הכותרת
    }

    async function buildDynamicSlides() {
        const frame = document.getElementById('main-frame');
        
        // 1. מחיקת שקופיות דינמיות ישנות
        const existingDynamic = document.querySelectorAll('.dynamic-slide');
        existingDynamic.forEach(el => el.remove());

        // ============================================================
        // חלק א': רשימות מובנות (קוראים, בעלי תפקידים, תורמים)
        // ============================================================
        try {
            const listData = await fetchCSV(READERS_CSV_URL);
            
            if (listData.length > 0) {
                let slidesContent = [];
                // ברירת מחדל: אם אין כותרת בהתחלה, נקרא לזה "רשימה"
                let currentSlide = { title: "קוראים בתורה", items: [] }; 
                let isNextLineTitle = false;

                listData.forEach(row => {
                    const col1 = row[0] ? row[0].trim() : '';
                    const col2 = row[1] ? row[1].trim() : '';
                    
                    // דילוג על שורות ריקות לגמרי
                    if (!col1 && !col2) return;

                    // זיהוי דף חדש
                    if (col1.includes('*****')) {
                        if (currentSlide.items.length > 0) {
                            slidesContent.push(currentSlide);
                        }
                        currentSlide = { title: "", items: [] };
                        isNextLineTitle = true;
                    } 
                    else if (isNextLineTitle) {
                        // השורה שאחרי הכוכביות היא הכותרת
                        currentSlide.title = col1; // הכותרת נמצאת בעמודה הראשונה
                        isNextLineTitle = false;
                    } 
                    else {
                        // שורה רגילה של מידע (תפקיד + שם)
                        currentSlide.items.push({ role: col1, name: col2 });
                    }
                });

                // הוספת השקופית האחרונה
                if (currentSlide.items.length > 0) {
                    slidesContent.push(currentSlide);
                }

                // יצירת ה-HTML
                slidesContent.forEach(slide => {
                    const div = document.createElement('div');
                    div.className = 'slide dynamic-slide';
                    
                    // בניית הרשימה עם ה-CSS של role שכבר בנינו
                    let html = `<h1>${slide.title}</h1><div class="content-box"><ul>`;
                    slide.items.forEach(item => {
                        html += `<li>
                                    <span class="role">${item.role}</span>
                                    <span>${item.name}</span>
                                 </li>`;
                    });
                    html += `</ul></div>`;
                    
                    div.innerHTML = html;
                    frame.insertBefore(div, document.getElementById('progress'));
                });
            }
        } catch (e) { console.error("Error fetching Lists:", e); }

        // ============================================================
        // חלק ב': הודעות וחדשות (טקסט חופשי ותמונות)
        // ============================================================
        try {
            const newsData = await fetchCSV(NEWS_CSV_URL);
            
            if (newsData.length > 0) {
                let slidesContent = [];
                let currentSlide = { title: "הודעות הקהילה", items: [] };
                let isNextLineTitle = false;

                newsData.forEach(row => {
                    const text = row[0] ? row[0].trim() : '';
                    if (!text) return;

                    if (text.includes('*****')) {
                        if (currentSlide.items.length > 0 || currentSlide.title !== "הודעות הקהילה") {
                            slidesContent.push(currentSlide);
                        }
                        currentSlide = { title: "", items: [] };
                        isNextLineTitle = true;
                    } 
                    else if (isNextLineTitle) {
                        currentSlide.title = text;
                        isNextLineTitle = false;
                    } 
                    else {
                        if (text.startsWith('IMG:')) {
                            const imgUrl = text.replace('IMG:', '').trim();
                            currentSlide.items.push({ type: 'image', value: imgUrl });
                        } else {
                            currentSlide.items.push({ type: 'text', value: text });
                        }
                    }
                });

                if (currentSlide.items.length > 0) {
                    slidesContent.push(currentSlide);
                }

                slidesContent.forEach(slide => {
                    const div = document.createElement('div');
                    div.className = 'slide dynamic-slide';
                    let html = `<h1>${slide.title}</h1><div class="content-box"><ul>`;
                    slide.items.forEach(item => {
                        if (item.type === 'image') {
                            html += `<img src="${item.value}" class="slide-image" alt="תמונה">`;
                        } else {
                            html += `<li>${item.value}</li>`;
                        }
                    });
                    html += `</ul></div>`;
                    div.innerHTML = html;
                    frame.insertBefore(div, document.getElementById('progress'));
                });
            }
        } catch (e) { console.error("Error fetching News:", e); }
        
        slides = document.querySelectorAll('.slide');
    }

    async function loadShabbatTimes() {
        try {
            // 1. שליפת זמני השבת
            const response = await fetch('https://www.hebcal.com/shabbat?cfg=json&geonameid=294071&M=on&t=' + new Date().getTime()); 
            const data = await response.json();
            
            // מציאת הפרשה (וממנה נגזור את תאריך השבת)
            const parashaItem = data.items.find(i => i.category === "parashat");
            let shabbatDateISO = ""; // משתנה לשמירת התאריך הלועזי של שבת

            if(parashaItem) {
                document.getElementById('parasha-name').innerText = "פרשת " + parashaItem.hebrew;
                // parashaItem.date מחזיר את תאריך השבת בפורמט YYYY-MM-DD
                shabbatDateISO = parashaItem.date.substring(0, 10);
            }
            
            // זמנים
            const candles = data.items.find(i => i.category === "candles");
            if(candles) {
                const d = new Date(candles.date);
                document.getElementById('candles-time').innerText = d.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
            }

            const havdalah = data.items.find(i => i.category === "havdalah");
            if(havdalah) {
                 const d = new Date(havdalah.date);
                document.getElementById('havdalah-time').innerText = d.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
            }

            // 2. המרת התאריך לעברי (קריאה נוספת ל-API)
            if (shabbatDateISO) {
                try {
                    const dateRes = await fetch(`https://www.hebcal.com/converter?cfg=json&date=${shabbatDateISO}&g2h=1&strict=1`);
                    const dateData = await dateRes.json();
                    const cleanDate = dateData.hebrew.replace(/[\u0591-\u05C7]/g, '');
                    document.getElementById('hebrew-date-display').innerText = cleanDate;
                } catch (err) {
                    console.log("Error converting date");
                }
            }

        } catch(e) { console.log("Hebcal error", e); }
    }
    // --- לוגיקת גלילה (מהקוד הקודם) ---
    function startAutoScroll(slideElement) {
        const box = slideElement.querySelector('.content-box');
        if (box) box.scrollTop = 0;
        
        if (box && box.scrollHeight > box.clientHeight) {
            setTimeout(() => {
                const distance = box.scrollHeight - box.clientHeight;
                const timeAvailable = SLIDE_DURATION - 3000; 
                const speed = distance / (timeAvailable / 20); 
                
                scrollInterval = setInterval(() => {
                    box.scrollTop += 1; 
                    if (box.scrollTop + box.clientHeight >= box.scrollHeight) {
                        clearInterval(scrollInterval);
                    }
                }, 30); 
            }, 2000);
        }
    }

    // --- ניהול המצגת ---
    async function showSlide(index) {
        // בדיקה: אם חזרנו להתחלה, האם הגיע הזמן לרענן נתונים?
        const now = new Date().getTime();
        if (index === 0 && (now - lastFetchTime > REFRESH_INTERVAL)) {
            console.log("Refreshing data...");
            await buildDynamicSlides(); // בנייה מחדש של ה-DOM
            await loadShabbatTimes();
            lastFetchTime = now;
        }

        if (scrollInterval) clearInterval(scrollInterval);
        
        // עדכון NodeList למקרה שהשתנה
        slides = document.querySelectorAll('.slide');
        
        // הגנה מפני אינדקס חורג (אם מחקנו שקופיות)
        if (index >= slides.length) index = 0;
        currentSlideIndex = index;

        slides.forEach(s => s.classList.remove('active'));
        slides[currentSlideIndex].classList.add('active');
        
        startAutoScroll(slides[currentSlideIndex]);
        
        const bar = document.getElementById('progress');
        bar.style.transition = 'none';
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = `width ${SLIDE_DURATION}ms linear`;
            bar.style.width = '100%';
        }, 50);
    }

    function nextSlide() {
        // קידום האינדקס
        let nextIndex = (currentSlideIndex + 1) % slides.length;
        showSlide(nextIndex);
    }

    // --- אתחול ראשוני ---
    async function init() {
        await loadShabbatTimes();
        await buildDynamicSlides();
        document.getElementById('loader').style.display = 'none';
        lastFetchTime = new Date().getTime();
        
        slides = document.querySelectorAll('.slide');
        showSlide(0);
        setInterval(nextSlide, SLIDE_DURATION);
    }

    function updateClock() {
        const now = new Date();
        // עיצוב הזמן בפורמט HH:MM:SS
        const timeString = now.toLocaleTimeString('he-IL', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        const clockEl = document.getElementById('digital-clock');
        if (clockEl) clockEl.innerText = timeString;
    }

    // הפעלה ראשונית
    updateClock();
    
    // עדכון כל שנייה
    setInterval(updateClock, 1000);

    init();
    
    // ריענון דף מלא פעם ב-4 שעות ליתר ביטחון (ניקוי זיכרון)
    setTimeout(() => location.reload(), 14400000); 

</script>
</body>
</html>
